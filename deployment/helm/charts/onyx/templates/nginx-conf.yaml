###############################################################################
# NOTE: If you make changes to this file, increment the following in values.yaml
# before running `helm upgrade` to trigger an automatic nginx restart:
#
#   nginx.controller.podAnnotations:
#     onyx.app/nginx-config-version: "<new_version>"
#
# Otherwise, changes won't apply until you manually restart the nginx pods.
###############################################################################

apiVersion: v1
kind: ConfigMap
metadata:
  name: onyx-nginx-conf
data:
  upstreams.conf: |
    upstream api_server {
        server {{ include "onyx.fullname" . }}-api-service:{{ .Values.api.service.servicePort }} fail_timeout=0;
    }

    upstream web_server {
        server {{ include "onyx.fullname" . }}-webserver:{{ .Values.webserver.service.servicePort }} fail_timeout=0;
    }
    {{- if .Values.mcpServer.enabled }}

    upstream mcp_server {
        server {{ include "onyx.fullname" . }}-mcp-server-service:{{ .Values.mcpServer.service.servicePort }} fail_timeout=0;
    }
    {{- end }}

  server.conf: |
    server {
        listen 1024;
        server_name $$DOMAIN;

        client_max_body_size 5G;
        {{- if .Values.mcpServer.enabled }}

        # MCP Server - Model Context Protocol for LLM integrations
        # Match /mcp, /mcp/, or /mcp/* but NOT /mcpserver, /mcpapi, etc.
        location ~ ^/mcp(/.*)?$ {
            rewrite ^/mcp(/.*)$ $1 break;
            rewrite ^/mcp/?$ / break;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header Host $host;
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_redirect off;
            # timeout settings
            proxy_connect_timeout {{ .Values.nginx.timeouts.connect }}s;
            proxy_send_timeout {{ .Values.nginx.timeouts.send }}s;
            proxy_read_timeout {{ .Values.nginx.timeouts.read }}s;
            proxy_pass http://mcp_server;
        }
        {{- end }}

        location ~ ^/api(.*)$ {
            rewrite ^/api(/.*)$ $1 break;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header Host $host;
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_redirect off;
            # timeout settings
            proxy_connect_timeout {{ .Values.nginx.timeouts.connect }}s;
            proxy_send_timeout {{ .Values.nginx.timeouts.send }}s;
            proxy_read_timeout {{ .Values.nginx.timeouts.read }}s;
            proxy_pass http://api_server;
        }

        location / {
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header Host $host;
            proxy_http_version 1.1;
            proxy_redirect off;
            # timeout settings
            proxy_connect_timeout {{ .Values.nginx.timeouts.connect }}s;
            proxy_send_timeout {{ .Values.nginx.timeouts.send }}s;
            proxy_read_timeout {{ .Values.nginx.timeouts.read }}s;
            proxy_pass http://web_server;
        }
    }
