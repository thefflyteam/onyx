{{- if (include "onyx.pgInto.enabled" .) }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "onyx.pgInto.configMapName" . }}
  labels:
    {{- include "onyx.labels" . | nindent 4 }}
data:
  pginto: |
    #!/usr/bin/env sh
    set -eu

    HOST="${POSTGRES_HOST:-localhost}"
    PORT="${POSTGRES_PORT:-5432}"
    USER="${POSTGRES_USER:-postgres}"
    DB="${POSTGRES_DB:-postgres}"
    PSQL_BIN="${PGINTO_PSQL_BIN:-{{ default "psql" .Values.tooling.pgInto.psqlBinary }}}"
    USE_IAM="$(printf '%s' "${USE_IAM_AUTH:-false}" | tr '[:upper:]' '[:lower:]')"

    if ! command -v "${PSQL_BIN}" >/dev/null 2>&1; then
      echo "psql client '${PSQL_BIN}' not found in PATH" >&2
      exit 1
    fi

    if [ "${USE_IAM}" = "true" ]; then
      REGION="${AWS_REGION:-${AWS_DEFAULT_REGION:-${AWS_REGION_NAME:-}}}"
      if [ -z "${REGION}" ]; then
        REGION="$(printf "%s\n" "${HOST}" | sed -n 's/.*\.\([a-z0-9-]*\)\.rds\.amazonaws\.com.*/\1/p')"
      fi
      if [ -z "${REGION}" ]; then
        echo "USE_IAM_AUTH is true but AWS region is not set (AWS_REGION/AWS_DEFAULT_REGION/AWS_REGION_NAME)" >&2
        exit 1
      fi
      PY_BIN="$(command -v python3 || command -v python || true)"
      if [ -z "${PY_BIN}" ]; then
        echo "python is required to generate RDS IAM auth token" >&2
        exit 1
      fi
      if [ -z "${PGSSLMODE:-}" ]; then
        export PGSSLMODE=require
      fi
      PGPASSWORD="$("${PY_BIN}" -c 'import sys,boto3; host,port,user,region=sys.argv[1:]; port_int=int(port); token=boto3.client("rds", region_name=region).generate_db_auth_token(DBHostname=host, Port=port_int, DBUsername=user); sys.stdout.write(token)' "${HOST}" "${PORT}" "${USER}" "${REGION}")"
      if [ -z "${PGPASSWORD}" ]; then
        echo "failed to generate IAM auth token" >&2
        exit 1
      fi
      export PGPASSWORD
    else
      if [ -z "${PGPASSWORD:-}" ] && [ -n "${POSTGRES_PASSWORD:-}" ]; then
        export PGPASSWORD="${POSTGRES_PASSWORD}"
      fi

      if [ -z "${PGPASSWORD:-}" ]; then
        printf "Postgres password: " >&2
        if command -v stty >/dev/null 2>&1; then
          stty -echo || true
        fi
        if ! read -r PGPASSWORD; then
          echo "failed to read password" >&2
          exit 1
        fi
        if command -v stty >/dev/null 2>&1; then
          stty echo || true
        fi
        printf "\n" >&2
        export PGPASSWORD
      fi
    fi

    if [ -n "${POSTGRES_SSLMODE:-}" ] && [ -z "${PGSSLMODE:-}" ]; then
      export PGSSLMODE="${POSTGRES_SSLMODE}"
    fi

    echo "Connecting to ${DB} on ${HOST}:${PORT} as ${USER}"
    exec "${PSQL_BIN}" -h "${HOST}" -p "${PORT}" -U "${USER}" "${DB}" "$@"
{{- end }}
